<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="egovframework.com.egowaeyo.approval.mapper.ApprovalMapper">

	<select id="selectFormList"
		resultType="egovframework.com.egowaeyo.approval.VO.ApprovalFormVO">
		SELECT apprform_id, aporm_name FROM approval_form
	</select>

	<insert id="insertApprovalDoc" parameterType="ApprovalDocVO">
		<selectKey keyProperty="docId" order="BEFORE"
			resultType="string">
			SELECT TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') ||
			LPAD(approval_doc_seq.NEXTVAL, 6, '0') FROM dual
		</selectKey>
		INSERT INTO approval_doc (
		doc_id, doc_title, EMPLYR_ID, doc_status,
		created_dt, apprform_id, doc_html
		) VALUES (
		#{docId}, #{docTitle},
		#{emplId}, #{docStatus}, #{createdDt}, #{apprformId},
		#{docHtml}
		)
	</insert>

	<insert id="insertApprovalLine" parameterType="ApprovalLineVO">
		INSERT INTO
		approval_line (
		line_id, doc_id, approver_id, line_order, line_status
		)
		VALUES (
		approval_line_seq.NEXTVAL, #{docId}, #{approverId},
		#{lineOrder}, #{lineStatus}
		)
	</insert>

	<insert id="insertApprovalCc" parameterType="ApprovalCcVO">
		INSERT INTO
		approval_cc (
		cc_id, doc_id, EMPLYR_ID
		) VALUES (
		approval_cc_seq.NEXTVAL, #{docId}, #{emplyrId}
		)
	</insert>

	<insert id="insertTemp" parameterType="ApprovalTempVO">
		INSERT INTO approval_temp
		(temp_id, EMPLYR_ID, temp_title, temp_content, temp_dt)
		VALUES
		(approval_temp_seq.NEXTVAL, #{emplyrId}, #{tempTitle},
		#{tempContent},
		SYSDATE)
	</insert>

	<!-- 개인 수신함 -->
	<select id="selectReceiveList" parameterType="String"
		resultType="egovframework.com.egowaeyo.approval.VO.ApprovalDocVO">
		SELECT
		d.doc_id AS docId,
		d.doc_title AS docTitle,
		d.doc_status AS docStatus,
		d.created_dt AS createdDt,
		u.user_nm AS drafterName,
		o.orgnzt_nm AS deptName,
		LISTAGG(a.user_nm, ', ') WITHIN GROUP (ORDER BY l.line_order) AS approverNames
		FROM approval_doc d
		JOIN comtnemplyrinfo u ON d.emplr_id = u.emplyr_id
		LEFT JOIN comtnorgnztinfo o ON u.orgnzt_id = o.orgnzt_id
		LEFT JOIN approval_line l ON d.doc_id = l.doc_id
		LEFT JOIN comtnemplyrinfo a ON l.approver_id = a.emplyr_id
		WHERE l.approver_id = #{empId}
		GROUP BY d.doc_id, d.doc_title, d.doc_status, d.created_dt, u.user_nm,
		o.orgnzt_nm
		ORDER BY d.created_dt DESC
	</select>

	<!-- 부서 수신함 -->
	<select id="selectDeptReceiveList" parameterType="String"
		resultType="egovframework.com.egowaeyo.approval.VO.ApprovalDocVO">
		SELECT ad.*
		FROM approval_doc ad
		JOIN emp e ON ad.EMPLYR_ID =
		e.EMPLYR_ID
		WHERE e.DEPT_ID = #{deptId}
		AND ad.doc_status = '진행중'
	</select>

	<!-- 임시보관함 -->
	<select id="selectTempList" parameterType="String"
		resultType="egovframework.com.egowaeyo.approval.VO.ApprovalTempVO">
		SELECT * FROM approval_doc WHERE drafter_id = #{empId}
	</select>

	<!-- 참조(공람)자로 들어간 모든 문서 -->
	<select id="selectReferenceList" parameterType="String"
		resultType="egovframework.com.egowaeyo.approval.VO.ApprovalCcVO">
		SELECT
		ac.cc_id,
		ac.EMPLYR_ID,
		ac.cc_status,
		ac.read_dt,
		ac.doc_id,
		ad.doc_title,
		ad.EMPLYR_ID AS drafter_name,
		ad.doc_status,
		ad.created_dt,
		ad.final_dt
		FROM approval_cc ac
		JOIN approval_doc ad ON
		ac.doc_id = ad.doc_id
		WHERE ac.EMPLYR_ID = #{empId}
		ORDER BY
		ad.created_dt DESC
	</select>

	<select id="selectApprovalDetail"
		resultType="egovframework.com.egowaeyo.approval.VO.ApprovalDetailVO">
		SELECT
		d.doc_id AS docId,
		d.doc_title AS docTitle,
		d.doc_status AS docStatus,
		d.created_dt AS createdDt,
		d.doc_html AS
		docHtml,
		u.user_nm AS empName,
		o.orgnzt_nm AS deptName
		FROM approval_doc
		d
		JOIN approval_form f ON d.apprform_id = f.apprform_id
		JOIN
		comtnemplyrinfo u ON d.emplyr_id = u.emplyr_id
		LEFT JOIN
		comtnorgnztinfo o ON u.orgnzt_id = o.orgnzt_id
		WHERE d.doc_id =
		#{docId}
	</select>

	<select id="selectApprFormHtml" parameterType="string"
		resultType="string">
		SELECT apprform_html FROM approval_form WHERE apprform_id =
		#{formId}
	</select>

	<select id="selectDeptList"
		resultType="egovframework.com.egowaeyo.admin.service.EgovDeptVO">
		SELECT orgnzt_Id,
		orgnzt_Nm,
		orgnzt_Dc
		FROM
		COMTNORGNZTINFO
	</select>

	<select id="selectEmpListByDept" parameterType="string"
		resultType="egovframework.com.egowaeyo.admin.service.AdminUserVO">
		SELECT EMPLYR_ID,
		USER_NM
		FROM
		COMTNEMPLYRINFO
		WHERE ORGNZT_ID
		= #{deptId}
	</select>

	<select id="selectAllUsers" parameterType="string"
		resultType="egovframework.com.egowaeyo.admin.service.AdminUserVO">
		SELECT EMPLYR_ID AS empId,
		USER_NM,
		ORGNZT_ID
		AS deptId
		FROM
		COMTNEMPLYRINFO
	</select>
</mapper>