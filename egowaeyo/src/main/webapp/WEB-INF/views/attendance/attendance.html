<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">

<!-- th:blockë¶€ë¶„ì´ defalut.html ì—ì„œ ì§€ì •í•œ layout:fragment="customContents" ì˜ì—­ì— ë“¤ì–´ê°„ë‹¤.  -->

<section layout:fragment="content">
	<link rel="stylesheet" th:href="@{/assets/css/toastUi/toastUi.css}">
	<style>
.search-box {
	display: flex;
	align-items: center;
	gap: 0.5rem;
	justify-content: flex-end;
	margin-bottom: 10px;
}

.search-box input {
	width: 150px;
}

#grid {
	height: 450px;
}

.table-responsive {
	overflow: inherit;
}

.tui-datepicker, .tui-calendar {
	position: relative;
	z-index: 3000 !important;
}

.valid {
	color: #28a745;
	font-weight: bold;
}

.invalid {
	color: #dc3545;
	font-weight: bold;
}

.time-input {
	width: 100%;
	height: 100%;
	border: 2px solid #ddd;
	text-align: center;
	font-size: 14px;
	font-family: 'Courier New', monospace;
	outline: none;
	padding: 4px;
}

.time-input.valid {
	border-color: #4caf50;
	background-color: #e8f5e8;
}

.time-input.invalid {
	border-color: #f44336;
	background-color: #ffebee;
}

.time-format {
	background: #fff3cd;
	padding: 10px;
	border-radius: 4px;
	margin-bottom: 15px;
	border-left: 4px solid #ffc107;
}

/* ì‹œê°„ í˜•ì‹ ì•ˆë‚´ */
.time-format-info {
	background: #e3f2fd;
	padding: 8px 12px;
	border-radius: 4px;
	margin-bottom: 15px;
	border-left: 4px solid #2196f3;
	font-size: 13px;
}
</style>
	<div class="container mt-4">
		<h5 class="title">ë‚´ ì¶œí‡´ê·¼ ë‚´ì—­</h5>
		
		<!-- ì‹œê°„ í˜•ì‹ ì•ˆë‚´ -->
		<div class="time-format-info">
			ğŸ’¡ ì‹œê°„ ì…ë ¥ í˜•ì‹: <strong>HHMM</strong> (ì˜ˆ: 0900, 1730) - 4ìë¦¬ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.
		</div>

		<div class="search-box">
			<button class="btn btn-success btn-sm">ì •ì •ì‹ ì²­</button>

			<div class="tui-datepicker-input tui-datetime-input tui-has-focus">
				<input id="startpicker-input" type="date" aria-label="Date">
				<span class="tui-ico-date"></span>
				<div id="startpicker-container" style="margin-left: -1px;"></div>
			</div>
			<span>to</span>
			<div class="tui-datepicker-input tui-datetime-input tui-has-focus">
				<input id="endpicker-input" type="date" aria-label="Date"> <span
					class="tui-ico-date"></span>
				<div id="endpicker-container" style="margin-left: -1px;"></div>
			</div>


			<button class="btn btn-dark btn-sm">
				<i class="bi bi-search"></i>
			</button>
		</div>

		<div class="table-responsive">
			<div id="grid"></div>
		</div>
	</div>


	<script th:inline="javascript">
var Grid = tui.Grid;
var today = new Date();

let data = {};
let gridData;
let list;

// ì‹œê°„ í˜•ì‹ ê²€ì¦ í•¨ìˆ˜ (HHMM)
function validateTimeFormat(value) {
	// ë¹ˆ ê°’ì€ í—ˆìš©
	if (!value || value === '') return true;
	
	// 4ìë¦¬ ìˆ«ìì¸ì§€ í™•ì¸
	if (!/^\d{4}$/.test(value)) {
		return false;
	}
	
	const hours = parseInt(value.substring(0, 2));
	const minutes = parseInt(value.substring(2, 4));
	
	// ì‹œê°„: 00-23, ë¶„: 00-59 ë²”ìœ„ í™•ì¸
	return hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59;
}

// ì‹œê°„ í˜•ì‹ í¬ë§·íŒ… í•¨ìˆ˜
function formatTime(value) {
	if (!value) return '';
	
	// ìˆ«ìë§Œ ì¶”ì¶œ
	const numbers = value.replace(/[^\d]/g, '');
	
	// 4ìë¦¬ë¡œ ì œí•œ
	if (numbers.length > 4) {
		return numbers.substring(0, 4);
	}
	
	return numbers;
}

// ì»¤ìŠ¤í…€ ì‹œê°„ ì—ë””í„°
class TimeEditor {
	constructor(props) {
		this.el = document.createElement('input');
		this.el.type = 'text';
		this.el.maxLength = 4;
		this.el.className = 'time-input';
		this.el.placeholder = 'HHMM';
		
		// ì´ˆê¸°ê°’ ì„¤ì •
		this.el.value = String(props.value || '');
		this.validateAndStyle();
		
		// ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
		this.el.addEventListener('input', (e) => {
			// ìˆ«ìë§Œ í—ˆìš©
			let value = formatTime(e.target.value);
			e.target.value = value;
			
			this.validateAndStyle();
		});

		// í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì²˜ë¦¬
		this.el.addEventListener('keydown', (e) => {
			// í—ˆìš©ëœ í‚¤ë“¤
			const allowedKeys = [
				'Backspace', 'Delete', 'Tab', 'Enter', 'Escape',
				'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown',
				'Home', 'End'
			];
			
			// ìˆ«ì í‚¤ ë˜ëŠ” í—ˆìš©ëœ í‚¤ê°€ ì•„ë‹ˆë©´ ì°¨ë‹¨
			if (!allowedKeys.includes(e.key) && !/^\d$/.test(e.key)) {
				e.preventDefault();
			}
		});

		// í¬ì»¤ìŠ¤ ì‹œ ì „ì²´ ì„ íƒ
		this.el.addEventListener('focus', () => {
			this.el.select();
		});

		// ë¸”ëŸ¬ ì‹œ ìë™ ì™„ì„±
		this.el.addEventListener('blur', () => {
			this.autoComplete();
		});
		
		// ì—”í„° í‚¤ ì‹œ ìë™ ì™„ì„±
		this.el.addEventListener('keydown', (e) => {
			if (e.key === 'Enter') {
				this.autoComplete();
			}
		});
	}

	validateAndStyle() {
		const value = this.el.value;
		
		if (value === '') {
			// ë¹ˆ ê°’ì¼ ë•ŒëŠ” ê¸°ë³¸ ìŠ¤íƒ€ì¼
			this.el.classList.remove('valid', 'invalid');
		} else if (value.length === 4 && validateTimeFormat(value)) {
			// ìœ íš¨í•œ ì‹œê°„ í˜•ì‹
			this.el.classList.remove('invalid');
			this.el.classList.add('valid');
		} else if (value.length > 0) {
			// ìœ íš¨í•˜ì§€ ì•Šì€ ì‹œê°„ í˜•ì‹
			this.el.classList.remove('valid');
			this.el.classList.add('invalid');
		} else {
			this.el.classList.remove('valid', 'invalid');
		}
	}

	autoComplete() {
		let value = this.el.value;
		
		// ë¹ˆ ê°’ì´ë©´ ê·¸ëŒ€ë¡œ ìœ ì§€
		if (!value || value === '') {
			this.validateAndStyle();
			return;
		}
		
		// 1~3ìë¦¬ì¸ ê²½ìš° ì•ì— 0 ì¶”ê°€
		if (value.length === 1) {
			value = '000' + value;
		} else if (value.length === 2) {
			value = '00' + value;
		} else if (value.length === 3) {
			value = '0' + value;
		}
		
		// ìœ íš¨ì„± ê²€ì‚¬ í›„ ì„¤ì •
		if (value.length === 4) {
			const hours = parseInt(value.substring(0, 2));
			const minutes = parseInt(value.substring(2, 4));
			
			// ì‹œê°„ì´ 23ì„ ì´ˆê³¼í•˜ë©´ 23ìœ¼ë¡œ ì„¤ì •
			if (hours > 23) {
				value = '23' + value.substring(2, 4);
			}
			
			// ë¶„ì´ 59ë¥¼ ì´ˆê³¼í•˜ë©´ 59ë¡œ ì„¤ì •
			if (minutes > 59) {
				value = value.substring(0, 2) + '59';
			}
			
			this.el.value = value;
			this.validateAndStyle();
		}
	}

	getElement() {
		return this.el;
	}

	getValue() {
		return this.el.value;
	}

	mounted() {
		this.el.focus();
	}
}

const editableColumns = ['checkin', 'checkout'];
const grid = new Grid({
	el: document.getElementById('grid'),
	scrollX: false,
	scrollY: false,
	rowHeaders: [
		{
			type: 'checkbox',
			header: `
				<label for="all-checkbox" class="checkbox">
					<input type="checkbox" id="all-checkbox" class="hidden-input" name="_checked" />
					<span class="custom-input"></span>
				</label>
			`
		}
	],
	columns: [
		// [Column-1] ì¶œê·¼ì¼
		{
			header: 'ë‚ ì§œ',
			name: 'date',
			sortable: true,
			resizable: true,
			align: 'center',
			filter: {
				type: 'text',
				showApplyBtn: true,
				showClearBtn: true
			}
		},
		// [Column-2] ì¶œê·¼ 
		{
			header: 'ì¶œê·¼ì‹œê°',
			name: 'checkin',
			sortable: true,
			resizable: true,
			align: 'center',
			editor: TimeEditor,
			validation: {
				validatorFn: function(value) {
					return validateTimeFormat(value);
				}
			},
			filter: {
				type: 'text',
				showApplyBtn: true,
				showClearBtn: true
			}
		},
		// [Column-3] ì¶œê·¼ ìƒíƒœ
		{
			header: 'ì¶œê·¼ ìƒíƒœ',
			name: 'instate',
			sortable: true,
			resizable: true,
			align: 'center',
			filter: {
				type: 'text',
				showApplyBtn: true,
				showClearBtn: true
			}
		},
		// [Column-4] í‡´ê·¼ 
		{
			header: 'í‡´ê·¼ì‹œê°',
			name: 'checkout',
			sortable: true,
			resizable: true,
			align: 'center',
			editor: TimeEditor,
			validation: {
				validatorFn: function(value) {
					return validateTimeFormat(value);
				}
			},
			filter: {
				type: 'text',
				showApplyBtn: true,
				showClearBtn: true
			}
		},
		// [Column-5] í‡´ê·¼ ìƒíƒœ
		{
			header: 'í‡´ê·¼ìƒíƒœ',
			name: 'outstate',
			sortable: true,
			resizable: true,
			align: 'center',
			filter: {
				type: 'text',
				showApplyBtn: true,
				showClearBtn: true
			}
		},
		// [Column-6] ì •ì •ì‹ ì²­ ìƒíƒœ
		{
			header: 'ì •ì •ì‹ ì²­',
			name: 'modstate',
			sortable: true,
			resizable: true,
			align: 'center',
			filter: {
				type: 'text',
				showApplyBtn: true,
				showClearBtn: true
			}
		}
	]
});

let url = /*[[@{/attendance}]]*/'';
getData(data);

function getData(data) {
	$.ajax({
		type: 'post',
		url: '/egowaeyo/attendList.do',
		headers: {
			"Content-Type": "application/json",
		},
		data: JSON.stringify(data),
		success: function(result) {
			console.log(result);
			list = result;
			result.forEach(item => {
				switch(item.modstate) {
					case "m01":
						item.modstate = `<button class="btn btn-sm btn-primary" disabled>ì§„í–‰ì¤‘</button>`;
						break;
					case "m02":
						item.modstate = `<button class="btn btn-sm btn-success" disabled>ì •ì •ì™„ë£Œ</button>`;
						break;
					default:
						item.modstate = ``;
				}
			});
			grid.resetData(result);
			disableAllEditing();
			grid.refreshLayout();
		},
		error: function(request, status, error) {
			console.log(error);
		}
	});
}

$('.btn.btn-dark.btn-sm').click(function() {
	console.log("ì¶œë ¥");
	data.startDate = $('#startpicker-input').val();
	data.endDate = $('#endpicker-input').val();
	getData(data);
});

grid.on('checkAll', () => grid.uncheckAll()); // ìƒë‹¨ ì „ì²´ì²´í¬ ë¬´ë ¥í™”
grid.on('check', ({ rowKey }) => {
	for(let i = 0; i < grid.getRowCount(); i++) {
		if(i != rowKey) {
			grid.uncheck(i);
			grid.disableCell(i, editableColumns[0]);
			grid.disableCell(i, editableColumns[1]);
		} else {
			grid.enableCell(i, editableColumns[0]);
			grid.enableCell(i, editableColumns[1]);
		}
	}
});

$('.btn.btn-success.btn-sm').click(function() {
	let dataForSend = list[grid.getCheckedRowKeys()[0]];
	console.log(dataForSend);
});

function disableAllEditing() {
	const rowCount = grid.getRowCount();
	for (let i = 0; i < rowCount; i++) {
		editableColumns.forEach(column => {
			grid.disableCell(i, column);
		});
	}
}

// ë°ì´í„° ë³€ê²½ ì´ë²¤íŠ¸ - ì‹œê°„ ê²€ì¦ í¬í•¨
grid.on('afterChange', function(ev) {
	if (ev.changes && ev.changes.length > 0) {
		ev.changes.forEach(change => {
			const { rowKey, columnName, value } = change;
			
			// checkin, checkout ì»¬ëŸ¼ì˜ ì‹œê°„ ê²€ì¦
			if ((columnName === 'checkin' || columnName === 'checkout') && value) {
				if (validateTimeFormat(value)) {
					console.log(`${columnName} ë³€ê²½ë¨: ${value} (ìœ íš¨í•¨)`);
					// ìœ íš¨í•œ ì‹œê°„ì´ë©´ ì…€ ìŠ¤íƒ€ì¼ ì •ìƒí™”
					grid.addCellClassName(rowKey, columnName, 'valid-time');
					grid.removeCellClassName(rowKey, columnName, 'invalid-time');
				} else {
					console.log(`${columnName} ë³€ê²½ë¨: ${value} (ìœ íš¨í•˜ì§€ ì•ŠìŒ)`);
					// ìœ íš¨í•˜ì§€ ì•Šì€ ì‹œê°„ì´ë©´ ê²½ê³  í‘œì‹œ
					grid.addCellClassName(rowKey, columnName, 'invalid-time');
					grid.removeCellClassName(rowKey, columnName, 'valid-time');
					
					// ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
					setTimeout(() => {
						alert(`ì˜ëª»ëœ ì‹œê°„ í˜•ì‹ì…ë‹ˆë‹¤.\nì˜¬ë°”ë¥¸ í˜•ì‹: HHMM (ì˜ˆ: 0900, 1730)\nì‹œê°„: 00-23, ë¶„: 00-59`);
					}, 100);
				}
			}
		});
	}
});

// ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨ ì´ë²¤íŠ¸
grid.on('failedValidation', function(ev) {
	console.log('ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨:', ev);
	if (ev.errors && ev.errors.length > 0) {
		const error = ev.errors[0];
		if (error.columnName === 'checkin' || error.columnName === 'checkout') {
			alert(`ì‹œê°„ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\nì˜¬ë°”ë¥¸ í˜•ì‹: HHMM (ì˜ˆ: 0900, 1730)\nì‹œê°„: 00-23, ë¶„: 00-59`);
		}
	}
});

// í¸ì§‘ ì‹œì‘ ì´ë²¤íŠ¸
grid.on('editingStart', function(ev) {
	const { columnName } = ev;
	if (columnName === 'checkin' || columnName === 'checkout') {
		console.log(`${columnName} í¸ì§‘ ì‹œì‘ - ì‹œê°„ í˜•ì‹: HHMM`);
	}
});

// í¸ì§‘ ì™„ë£Œ ì´ë²¤íŠ¸
grid.on('editingFinish', function(ev) {
	const { columnName, value } = ev;
	if ((columnName === 'checkin' || columnName === 'checkout') && value) {
		if (!validateTimeFormat(value)) {
			console.log(`${columnName} í¸ì§‘ ì™„ë£Œ - ìœ íš¨í•˜ì§€ ì•Šì€ ì‹œê°„: ${value}`);
			return false; // í¸ì§‘ ì·¨ì†Œ
		}
		console.log(`${columnName} í¸ì§‘ ì™„ë£Œ - ìœ íš¨í•œ ì‹œê°„: ${value}`);
	}
});


window.validateTimeFormat = validateTimeFormat;

</script>
</section>

</html>