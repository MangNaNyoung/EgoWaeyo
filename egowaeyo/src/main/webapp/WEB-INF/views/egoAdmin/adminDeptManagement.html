<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/layout}">
<section layout:fragment="content">
  <link rel="stylesheet" th:href="@{/assets/css/admin/adminDeptManagement.css}">

  <div class="main-container d-flex m-4 flex-column">
    <div class="main-first-section">
      <div class="main-small-title d-bolck pb-4">
        조직 관리
      </div>
      <div class="main-header-title fs-3 fw-bold pb-5">
        조직 현황
      </div>
    </div>
    <div class="main-second-section d-flex justify-content-between flex-row pb-4">
      <div class="button-section">
        <button class="border border-dark px-3 py-1 rounded-2 bg-white" id="deptInsert" data-bs-toggle="modal"
          data-bs-target="#exampleModal">부서추가</button>
        <button class="border border-dark px-3 py-1 rounded-2 bg-white" id="dedptUpdate">부서수정</button>
        <button class="border border-danger px-3 py-1 rounded-2 bg-danger text-white" id="deptDel">부서삭제</button>
      </div>
      <div>
        <div class="input-group">
          <div class="search-section input-group-text bg-white">
            <select class="form-select" aria-label="Default select example">
              <option selected>전체</option>
              <option value="1">이름</option>
              <option value="2">아이디</option>
              <option value="3">직급</option>
              <option value="4">사번</option>
              <option value="5">내선번호</option>
            </select>
            <!-- 검색창 -->
            <input type="text" class="py-1" placeholder="검색" id="all-search-input">
            <!-- id 값 중복 불가 'search-input' -> 'all-search-input' 으로 변경 -->
            <button class="border cursor-pointer bg-white border-0 ms-2" id="modal-search">
              <svg xmlns="http://www.w3.org/2000/svg" width="23" height="23" fill="currentColor" class="bi bi-search"
                viewBox="0 0 16 16">
                <path
                  d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="main-tf-section d-flex flex-row">
      <div class="main-third-section me-5">
        <div class="search-section">
          <!-- 검색창 -->
          <input type="text" class="" placeholder="검색" id="search-input">
          <button class="cursor-pointer border border-0 ps-3 bg-white" id="modal-search">
            <svg xmlns="http://www.w3.org/2000/svg" width="23" height="23" fill="currentColor" class="bi bi-search"
              viewBox="0 0 16 16">
              <path
                d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0" />
            </svg>
          </button>
        </div>
        <div class="dept-list-section pt-3">
          <!-- 부서 리스트 목록 -->
          <div class="">
            <ul class="list-group list-group-flush" id="department-list">
              
            </ul>
          </div>
        </div>
      </div>
      <div class="main-fourth-section flex-fill">
        <div class="dept-people-section">
          <table class="table text-dark">
            <thead>
              <tr>
                <th class=""><input type="checkbox"></th>
                <th class="">이름</th>
                <th class="">아이디</th>
                <th class="">소속부서</th>
                <th class="">직급</th>
                <th class="">사번</th>
                <th class="">내선번호</th>
                <th class="">휴대폰</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="py-3"><input type="checkbox"></td>
                <td class="py-3">김민지</td>
                <td class="py-3">KimMinJi</td>
                <td class="py-3">보안팀</td>
                <td class="py-3">보안팀장</td>
                <td class="py-3">250000</td>
                <td class="py-3">4681</td>
                <td class="py-3">010-0000-0000</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 부서추가 모달 -->
  <!-- Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">부서추가</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form action="">
            <div class="mb-3">
              <label for="Dept" class="form-dept">부서명</label>
              <input type="text" class="form-control">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary">부서추가</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        </div>
      </div>
    </div>
  </div>

<script>
  // 즉시 실행되는 테스트 코드
  /* console.log("=== 스크립트 실행 시작 ===");
  alert("스크립트가 실행되고 있습니다!"); */

  // DOM이 완전히 로드된 후 실행되도록 보장
  document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM 로드 완료");
    
    // jQuery 확인
    if (typeof $ === 'undefined') {
      console.error("jQuery가 로드되지 않았습니다!");
      return;
    }
    
    console.log("jQuery 로드 확인됨, 부서 목록 조회 시작");
    
    // 약간의 지연을 두고 실행
    setTimeout(function() {
      loadDepartmentList();
    }, 2000); // 2초 후 실행
  });

  function loadDepartmentList() {
    console.log("=== loadDepartmentList 함수 시작 ===");
    console.log("AJAX 요청 시작");
    
    // 간단한 테스트용 데이터 먼저 표시
    $('#department-list').html('<li class="list-group-item p-2">데이터 로딩 중...</li>');
    
    $.ajax({
      url: "egovdeptlist",
      type: "GET",
      dataType: "json",
      timeout: 10000, // 10초 타임아웃
      beforeSend: function() {
        console.log("AJAX 요청 전송 중...");
      },
      success: function(datas) {
        console.log("=== AJAX 성공 ===");
        console.log("받은 데이터:", datas);
        console.log("데이터 타입:", typeof datas);
        console.log("데이터 길이:", datas ? datas.length : 'null');
        
        $('#department-list').empty();
        
        if (datas && datas.length > 0) {
          datas.forEach(e => {
            console.log("부서 항목:", e);
            $('#department-list').append(
              `<li class="list-group-item p-2 dept-hover rounded-2 cursor-pointer" role="button" data-dept="${e.orgnztId}">${e.orgnztNm}</li>`
            );
          });
          console.log("부서 목록 렌더링 완료");
        } else {
          $('#department-list').append('<li class="list-group-item p-2">조직 정보가 없습니다.</li>');
          console.log("조직 정보 없음");
        }
      },
      error: function(xhr, status, error) {
        console.error("=== AJAX 오류 발생 ===");
        console.error("상태 코드:", xhr.status);
        console.error("상태 텍스트:", status);
        console.error("오류 메시지:", error);
        console.error("응답 텍스트:", xhr.responseText);
        console.error("xhr 객체:", xhr);
        
        $('#department-list').empty();
        $('#department-list').append('<li class="list-group-item p-2 text-danger">조직 목록을 불러올 수 없습니다: ' + error + '</li>');
      },
      complete: function() {
        console.log("=== AJAX 요청 완료 ===");
      }
    });
  }

  function searchDepartments() {
    const searchTerm = searchInput.value.toLowerCase().trim();

    if (searchTerm === "") {
      showAllDepartments();
      return;
    }

    const filterdDepts = departments.filter(dept =>
      dept.toLowerCase().includes(searchTerm)
    );

    displayDepartments(filterdDepts);
  }

  function showAllDepartments() {
    displayDepartments(departments);
  }

  function displayDepartments(deptList) {
    departmentList.innerHTML = "";

    deptList.forEach(dept => {
      const li = document.createElement("li");
      li.className = "list-group-item p-2 dept-hover rounded-2 cursor-pointer";
      li.setAttribute("data-dept", dept);
      li.textContent = `${dept}`;
      departmentList.appendChild(li);
    });
  }

  searchInput.addEventListener("input", searchDepartments);
</script>
</section>
</html>