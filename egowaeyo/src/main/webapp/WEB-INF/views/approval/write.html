<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">

<section layout:fragment="content">

	<div style="display: flex; gap: 2rem; align-items: flex-start;">

		<form th:action="@{/approval/write}" method="post" id="approvalForm"
			style="flex: 1;">
			<h4>결재문서</h4>
			<div
				style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-bottom: 1rem;">
				<button type="button" id="openTemplateModalBtn">양식선택</button>
				<button type="reset" id="resetBtn">초기화</button>
				<button type="button" id="attachFileBtn">결재문서첨부</button>
				<button type="button" id="tempSaveBtn">임시저장</button>
				<button type="submit" id="submitBtn">결재</button>
			</div>

			<div style="margin-bottom: 1rem;">
				<label for="docTitle" style="margin-right: 0.5rem;">제목:</label> 
				<input type="text" name="docTitle" required style="width: 100%;" /><br />
			</div>
			<div id="editor"></div>
			<textarea name="docContent" id="docContent" style="display: none;"></textarea>
		</form>

		<aside
			style="width: 300px; border-left: 1px solid #ccc; padding-left: 1rem; margin-top: 120px;">
			<div
				style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
				<h4 style="margin: 0;">결재선</h4>
				<button type="button" id="openApprovalLineModalBtn">결재선 지정</button>
			</div>
			<div class="approval-box">
				<strong>기안자</strong>
				<p>선택된 사용자 없음</p>
			</div>
			<div class="approval-box">
				<strong>결재자</strong>
				<p>선택된 사용자 없음</p>
			</div>
			<div class="approval-box">
				<strong>참조자</strong>
				<p>선택된 사용자 없음</p>
			</div>
		</aside>
	</div>

	<!-- 결재선 모달 -->
	<div id="approvalLineModal" class="modal">
		<div class="modal-overlay" onclick="closeModal(document.getElementById('approvalLineModal'))"></div>
		<div class="modal-content">
			<h4>결재선 지정</h4> 
			<div style="text-align: right; margin-top: 1rem;">
				<button id="applyApprovalLineBtn">결재선 적용</button>
				<button class="closeModalBtn">닫기</button>
			</div>
		</div>
	</div>

	<!-- 양식선택 모달 -->
	<div id="templateModal" class="modal">
		<div class="modal-overlay" onclick="closeModal(document.getElementById('templateModal'))"></div>
		<div class="modal-content">
			<h4>결재양식</h4>
			<div style="display: flex; gap: 1rem;">
				<div style="flex: 2; border: 1px solid #ccc;">
					<ul>
						<li class="template-item" data-id="FORM001" data-name="외근신청서">외근신청서</li>
						<li class="template-item" data-id="FORM002" data-name="휴가원">휴가원</li>
						<li class="template-item" data-id="FORM003" data-name="품의서">품의서</li>
					</ul>
				</div>
			</div>
			<div style="text-align: right; margin-top: 1rem;">
				<button class="closeModalBtn">닫기</button>
			</div>
		</div>
	</div>
</section>

<th:block layout:fragment="customJs">
	<script>
	let editor;
	document.addEventListener("DOMContentLoaded", function () {
		if (typeof toastui === 'undefined') return;
		editor = new toastui.Editor({
			el: document.querySelector('#editor'),
			height: '500px',
			initialEditType: 'wysiwyg',
			previewStyle: 'vertical',
			initialValue: ''
		});

		document.getElementById("openTemplateModalBtn").addEventListener("click", () => showModal("templateModal"));
		document.getElementById("openApprovalLineModalBtn").addEventListener("click", () => showModal("approvalLineModal"));

		document.querySelectorAll(".closeModalBtn").forEach(btn => {
			btn.addEventListener("click", e => closeModal(e.target.closest(".modal"))); 
		});

		document.getElementById("resetBtn").addEventListener("click", resetAll);
		document.getElementById("attachFileBtn").addEventListener("click", attachedFile);
		document.getElementById("tempSaveBtn").addEventListener("click", temporarySave);

		// submit 전에 editor html
		document.getElementById("submitBtn").addEventListener("click", () => {
			document.querySelector("#docContent").value = editor.getHTML();
		});

		document.querySelectorAll(".template-item").forEach(item => {
			  item.addEventListener("click", () => {
			    const formId = item.dataset.id;
			    fetch(`/egowaeyo/approval/form/${formId}`)
			      .then(res => {
			        if (!res.ok) throw new Error('양식이 없습니다');
			        return res.text();
			      })
			      .then(html => {
		                try { 
		                    html = JSON.parse(html);
		                } catch(e) { 
		                    html = html.replace(/^"+|"+$/g, "").replace(/\\n/g, "");
		                }
		                editor.setHTML(html);
		                closeModal(document.getElementById("templateModal"));
		            })
		            .catch(e => alert("양식 불러오기 실패"));
			  });
			});
	});

	function showModal(id) {
		const modal = document.getElementById(id);
		if (modal) modal.style.display = "block";
	}
	function closeModal(modal) {
		if (modal) modal.style.display = "none";
	}
	function resetAll() {
		document.getElementById("approvalForm").reset();
		if (editor) editor.setHTML("");
	}
	function attachedFile() {
		alert("첨부 파일 다이얼로그");
	}
	function temporarySave() {
		const content = editor.getHTML();
		const title = document.querySelector("input[name='docTitle']").value;
		if (!title || !content) return alert("제목과 내용을 입력해 주세요.");
		alert("임시 저장 완료");
	}
	</script>

	<style>
	.modal {
	  position: fixed;
	  top: 120px; 
	  left: 50%;
	  transform: translate(-50%, 0);
	  min-width: 400px;
	  min-height: 300px;
	  background: #fff;
	  border-radius: 8px;
	  box-shadow: 0 4px 24px #0002;
	  z-index: 1000;
	  padding: 2rem;
	  display: none;
	  width: 700px;
	  height: 400px;
	}
	.modal-content {
	  position: relative;
	  box-shadow: none;
	}
	aside {
	  margin-top: 120px; 
	}
	</style>
</th:block>
</html>
