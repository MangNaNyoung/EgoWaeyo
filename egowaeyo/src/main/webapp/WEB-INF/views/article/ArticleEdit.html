<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">
<main layout:fragment="content">
	<style>
/* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
body {
	background: #fff;
}

.custom-title {
	font-size: 20px;
	font-weight: 700;
	margin-bottom: 0;
	letter-spacing: -1px;
}

.custom-header {
	background: #fafafa;
	border-bottom: 2px solid #e5e5e5;
	padding: 25px 10px 20px 10px;
	margin-bottom: 0;
}

.avatar {
	width: 36px;
	height: 36px;
	background: #e5e5e5;
	border-radius: 50%;
	margin-right: 16px;
	margin-top: 5px;
	flex-shrink: 0;
}

li.li_name {
	margin-bottom: 15px;
}

/* content ìŠ¤íƒ€ì¼ */
</style>

	<!-- ì „ì²´ ë¬¸ì„œë¥¼ ê°ì‹¸ëŠ” div ì‹œì‘-->
	<div class="d-flex">
		<!-- slideë¥¼ ê°ì‹¸ëŠ” div ì‹œì‘-->
		<div id="slid" style="height: 1000px" class="col-2 border-end">
			<!-- slid ë‚´ìš© ì‹œì‘ -->
			<div id="board-panel" class="p-4 ps-0 mt-5">
				<h5>ê²Œì‹œíŒ</h5>

				<ul class="no_dot mt-4 fw-bold parentsProjects">
					<!--í”„ë¡œì íŠ¸ ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
				</ul>


				<ul class="no_dot">
					<li><span data-bs-toggle="modal"
						data-bs-target="#addProjectModal" style="cursor: pointer;">+
							ê²Œì‹œíŒì¶”ê°€</span></li>
				</ul>
			</div>
			<!-- slide ë‚´ìš© ë -->

		</div>
		<!-- slide ê°ì‹¸ëŠ” div ë -->

		<!-- ë‚´ìš©(ì›ë³¸) ê°ì‹¸ëŠ” div -->
		<div class="flex-grow-1 ">
			<!-- ë‚´ìš©(ì›ë³¸) ì‹œì‘  -->
			<div class="custom-header">
				<div class="container-fluid">
					<div class="d-flex align-items-center justify-content-between">
						<div class="custom-title"></div>


					</div>
				</div>
			</div>
			<!-- ìƒë‹¨ í—¤ë” -->
			<!-- content -->

			<form class="bg-white p-5 rounded" enctype="multipart/form-data"
				method="post" action="/article/articleUpdate">
				<div class="mb-3 row">
					<div class="mb-3 row">
						<label for="boardSelect"
							class="col-sm-1 col-form-label text-start">ê²Œì‹œíŒ</label>
						<div class="col-sm-2">
							<select id="boardSelect" class="form-select">
								<!-- ì˜µì…˜ì´ JavaScriptë¡œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
							</select>
						</div>
					</div>

					<div class="mb-3 row">
						<label for="titleInput" id="title"
							class="col-sm-1 col-form-label text-start">ì œëª©</label>
						<div class="col-sm-12">
							<input type="text" id="title-Input" class="form-control"
								name="nttSj">
						</div>
					</div>

					<div class="mb-3 row">
						<label for="Uploadfile" class="col-sm-1 col-form-label text-start"
							name="files" multiple>ì²¨ë¶€íŒŒì¼</label>
						<div class="col-sm-11">
							<div id="fileName" class="form-control">
								<input type="file" name="files" id="fileInput" multiple>
							</div>
						</div>
						<div class="mb-3">
							<label for="contentTextarea" class="form-label" name="nttCn">ë‚´ìš©</label>
							<textarea id="contentTextarea" class="form-control" rows="20"
								placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
						</div>

						<div class="text-center">
							<button type="button" class="btn btn-dark me-2" id="submitButton">ë“±ë¡</button>
							<button type="button" class="btn btn-secondary" id="cancelButton">ì·¨ì†Œ</button>
						</div>
					</div>
			</form>
		</div>
		<div th:replace="article/addProjectModal :: addProjectModal"></div>
		<div th:replace="article/editProjectModal :: editProjectModal"></div>
		<script th:inline=javaScript>
let barClicked = [[${barContect}]]
if (barClicked) {
	 barLending(barClicked);
console.log("barClicked:", barClicked); // ë””ë²„ê¹…ìš© ë¡œê·¸					 
}
let manageClick;
//ëª¨ë‹¬ ì—´ê¸°
function openModal() {
	fetch('addProjectModal.html')
		.then(response => response.text())
		.then(html => {
			const modalContainer = document.getElementById('modal-container');
			modalContainer.innerHTML = html;
			modalContainer.classList.remove('hidden');
		})
		.catch(error => console.error('Error loading modal:', error));
}
//ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
function closeModal() {
	const modalContainer = document.getElementById('modal-container');
	modalContainer.classList.add('hidden');
	modalContainer.innerHTML = ''; // ëª¨ë‹¬ ë‚´ìš© ì´ˆê¸°í™”
}


/* // í”„ë¡œì íŠ¸ ìˆ˜ì • ëª¨ë‹¬
function openModal() {
	fetch('editProjectModal.html')
		.then(response => response.text())
		.then(html => {
			const modalContainer = document.getElementById('modal-container');
			modalContainer.innerHTML = html;
			modalContainer.classList.remove('hidden');
		})
		.catch(error => console.error('Error loading modal:', error));
}

function closeModal() {
	const modalContainer = document.getElementById('modal-container');
	modalContainer.classList.add('hidden');
	modalContainer.innerHTML = ''; // ëª¨ë‹¬ ë‚´ìš© ì´ˆê¸°í™”
} */


//ì‚¬ì´ë“œë°”
document.addEventListener("DOMContentLoaded", function () {
fetch('/egowaeyo/bbsMaster/groupedBbsData')
.then(response => response.json())
.then(data => {
    console.log("Fetched Data:", data); // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€

    const parentProjectsList = document.querySelector("ul.parentsProjects");
    if (parentProjectsList) {
        parentProjectsList.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

        Object.entries(data).forEach(([codeNm, bbsList]) => {
            const groupItem = document.createElement("li");
            groupItem.classList.add("li_name");

            // 'ê³µì§€ì‚¬í•­'ì¼ ê²½ìš° codeNm ìˆ¨ê¸°ê¸°
            if (codeNm !== "ğŸ“Œ ê³µì§€ì‚¬í•­") {
                groupItem.textContent = codeNm;

                const ulImg = document.createElement("img");
                ulImg.setAttribute("data-bs-toggle", "modal");
                ulImg.setAttribute("data-bs-target", "#addProjectModal");
                ulImg.setAttribute("class", "img-icon addUnderBoard");
                ulImg.setAttribute("src", "/egowaeyo/assets/images/icon/manage.png");
                ulImg.setAttribute("style", "cursor: pointer; margin-left: 8px;");
                groupItem.appendChild(ulImg);
            }

            // ìƒˆë¡œìš´ ul íƒœê·¸ ìƒì„±
            const subList = document.createElement("ul");

            bbsList.forEach(bbs => {
                const listItem = document.createElement("li");
                listItem.classList.add("no_dot");
                listItem.setAttribute("style", "cursor: pointer; margin-left:-20px;");
                listItem.setAttribute("data-bbs-id", bbs.bbsId); // bbsNmì„ data ì†ì„±ìœ¼ë¡œ ì¶”ê°€
                listItem.setAttribute("data-code", bbs.code); // bbsNmì„ data ì†ì„±ìœ¼ë¡œ ì¶”ê°€

                const img = document.createElement("img");
                img.setAttribute("data-bs-toggle", "modal");
                img.setAttribute("data-bs-target", "#addProjectModal");
                img.setAttribute("class", "img-icon");
                img.setAttribute("src", "/egowaeyo/assets/images/icon/manage.png");
                img.setAttribute("style", "cursor: pointer; margin-left: 8px;");

                const textNode = document.createTextNode(bbs.bbsNm);

                // ê³µì§€ì‚¬í•­ì˜ bbsNmì— ìŠ¤íƒ€ì¼ ì ìš©
                if (codeNm === "ğŸ“Œ ê³µì§€ì‚¬í•­") {
                    listItem.style.cssText = "font-weight: bold !important; cursor: pointer; margin-left:-32px; margin-bottom: 10px;";
                }

                listItem.appendChild(textNode);
                listItem.appendChild(img);

                listItem.style.fontWeight = "normal"; // li íƒœê·¸ì— normal ìŠ¤íƒ€ì¼ ì ìš©
                subList.appendChild(listItem);
            });

            groupItem.appendChild(subList);
            parentProjectsList.appendChild(groupItem);
        });
    }
})
.catch(error => console.error('Error fetching grouped BBS data:', error));
});

document.addEventListener("DOMContentLoaded", function () {
const parentProjectsList = document.querySelector("ul.parentsProjects");

parentProjectsList.addEventListener("click", function (e) {
const clicked = e.target;

if (clicked.tagName === "LI" && clicked.textContent.trim() !== "") {
    const bbsId = clicked.getAttribute("data-bbs-id"); // ê²Œì‹œíŒ ID
	const bbsNm = clicked.textContent.trim(); // ê²Œì‹œíŒ ì´ë¦„
	
    if (!bbsId) {
        console.warn("bbsIdê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    // ì„ íƒí•œ ê²Œì‹œíŒ IDë¥¼ localStorageì— ì €ì¥
    localStorage.setItem("selectedBbsId", bbsId);

    // articleList í˜ì´ì§€ë¡œ ì´ë™
    window.location.href = "/egowaeyo/article/articleList.do"+ `?bbsId=${encodeURIComponent(bbsId)}&bbsNm=${encodeURIComponent(bbsNm)}`;
}
});
});

//ê²Œì‹œê¸€ ë°ì´í„°ë¥¼ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
function renderArticleDetail(article) {
    document.querySelector("#article-title").textContent = article.nttSj;
    document.querySelector("#article-content").textContent = article.nttCn;
    document.querySelector("#article-author").textContent = article.frstRegisterNm;
    document.querySelector("#article-date").textContent = article.frstRegisterPnttm;
    document.querySelector(".custom-title").textContent = article.bbsNm;
}


//ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸°
document.addEventListener("DOMContentLoaded", function () {
    // URLì—ì„œ bbsIdì™€ nttId íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
    const urlParams = new URLSearchParams(window.location.search);
    const bbsId = urlParams.get("bbsId");
    const nttId = urlParams.get("nttId");
    const fileNameContainer = document.querySelector("#fileName");

    if (!bbsId || !nttId) {
      console.error("bbsId ë˜ëŠ” nttIdê°€ URLì— ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    
 // ì‚­ì œ ë²„íŠ¼ ì¶”ê°€ í•¨ìˆ˜
    const addDeleteButton = (fileNameText) => {
        const deleteButton = document.createElement("button");
        deleteButton.type = "button"; // ë²„íŠ¼ íƒ€ì… ì„¤ì •
        deleteButton.className = "btn btn-danger btn-sm";
        deleteButton.style.marginLeft = "10px";
        deleteButton.style.cursor = "pointer";
        deleteButton.style.padding = "1px 6px 4px 6px"
        deleteButton.style.float = "right";
        
     // ì´ë¯¸ì§€ ìƒì„± ë° ë²„íŠ¼ì— ì¶”ê°€
        const deleteIcon = document.createElement("img");
        deleteIcon.src = "/egowaeyo/assets/images/icon/delete.webp"; // ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì •
        deleteIcon.style.width = "12px"; // ì´ë¯¸ì§€ í¬ê¸° ì„¤ì •
        deleteIcon.style.height = "17px";
        deleteIcon.style.filter = "invert(100%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(99%) contrast(102%)"; // ì´ë¯¸ì§€ ìƒ‰ìƒ ì„¤ì •
        deleteIcon.style.weight = "1px"; // ì´ë¯¸ì§€ êµµê¸° ì„¤ì •
        
        deleteButton.appendChild(deleteIcon); // ë²„íŠ¼ì— ì´ë¯¸ì§€ ì¶”ê°€

        deleteButton.addEventListener("click", function () {
            fileNameContainer.innerHTML = ""; // ê¸°ì¡´ íŒŒì¼ëª… ì œê±°
            renderFileInput(); // âœ… ì¤‘ë³µ ë°©ì§€ í¬í•¨ëœ í•¨ìˆ˜ í˜¸ì¶œ
            checkModification(); // ìˆ˜ì • ìƒíƒœ ë°˜ì˜
        });

        fileNameContainer.appendChild(fileNameText);
        fileNameContainer.appendChild(deleteButton);
    };

    // íŒŒì¼ ì²¨ë¶€ ì´ë²¤íŠ¸ ì²˜ë¦¬ í•¨ìˆ˜
    const handleFileChange = (event) => {
        const file = event.target.files[0];
        if (file) {
            fileNameContainer.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
            const fileNameText = document.createElement("span");
            fileNameText.textContent = file.name; // ìƒˆ íŒŒì¼ëª… í‘œì‹œ
            addDeleteButton(fileNameText); // ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
        }
    };

    // ì„œë²„ API í˜¸ì¶œ
    fetch(`/egowaeyo/article/selectArticleDetail?bbsId=${bbsId}&nttId=${nttId}`)
      .then(response => {
        if (!response.ok) {
        	throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
    	  
    	  if (data && Object.keys(data).length > 0) {
    		  const currentBbsId = data.bbsId; // ë°›ì•„ì˜¨ bbsIdë¥¼ currentBbsIdë¡œ ì„¤ì •
    		  
    		  // ë‘ ë²ˆì§¸ API í˜¸ì¶œ
              const boardSelect = document.getElementById("boardSelect");
              fetch('/egowaeyo/bbsMaster/groupedBbsData')
                  .then(response => response.json())
                  .then(groupedData => {
                      if (!groupedData || typeof groupedData !== 'object') {
                          console.error("API ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤:", groupedData);
                          return;
                      }

                      // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™”
                      boardSelect.innerHTML = "";

                      // ë°ì´í„° ì²˜ë¦¬ ë° ì˜µì…˜ ì¶”ê°€
                      Object.entries(groupedData).forEach(([codeNm, bbsList]) => {
                          bbsList.forEach(bbs => {
                              const option = document.createElement("option");
                              option.value = bbs.bbsId;
                              option.textContent = bbs.bbsNm;

                              // currentBbsIdì™€ ì¼ì¹˜í•˜ë©´ ì„ íƒ
                              if (bbs.bbsId === currentBbsId) {
                                  option.selected = true;
                              }

                              boardSelect.appendChild(option);
                          });
                      });
                  })
                  
    	      document.querySelector("#boardSelect").textContent = data.bbsNm;
    	      document.querySelector("#title-Input").value = data.nttSj;
    	      document.querySelector("#contentTextarea").textContent = data.nttCn.replace(/^<p>|<\/p>$/g, "");
    	  }
    	  if (data && data.bbsFileName) {
              // íŒŒì¼ëª… í‘œì‹œ
              const fileNameText = document.createElement("span");
              fileNameText.textContent = data.bbsFileName;
              addDeleteButton(fileNameText); // ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
          } else {
              // íŒŒì¼ ì²¨ë¶€ í™œì„±í™”
              const fileInput = document.createElement("input");
              fileInput.type = "file";
              fileInput.id = "fileInput";
              fileInput.name = "files";
              fileInput.addEventListener("change", handleFileChange); // ìƒˆ íŒŒì¼ ì²¨ë¶€ ì´ë²¤íŠ¸ ì¶”ê°€
              fileNameContainer.appendChild(fileInput);
          }
    })
    	  
    	  .catch(error => console.error("Error fetching article detail:", error));
  });
  
  // ì—…ë°ì´íŠ¸ ì²˜ë¦¬

    const boardSelect = document.getElementById("boardSelect");
    const titleInput = document.getElementById("title-Input");
    const contentTextarea = document.getElementById("contentTextarea");
    const fileNameContainer = document.querySelector("#fileName");
    const submitButton = document.getElementById("submitButton");
    const cancelButton = document.getElementById("cancelButton");

    // ì·¨ì†Œ ë²„íŠ¼ í•­ìƒ í™œì„±í™”
    cancelButton.disabled = false;

    // ë“±ë¡ ë²„íŠ¼ ì´ˆê¸° ìƒíƒœ ë¹„í™œì„±í™”
    submitButton.disabled = true;

    let isModified = false;

    // ìˆ˜ì • ì—¬ë¶€ ê°ì§€
    const checkModification = () => {
        isModified = true;
        submitButton.disabled = false; // ë“±ë¡ ë²„íŠ¼ í™œì„±í™”
    };

    boardSelect.addEventListener("change", checkModification);
    titleInput.addEventListener("input", checkModification);
    contentTextarea.addEventListener("input", checkModification);

    // íŒŒì¼ ë³€ê²½ ë° ì‚­ì œ ì‹œ ìˆ˜ì • ìƒíƒœ ë°˜ì˜
    fileNameContainer.addEventListener("change", function (event) {
        const fileInput = fileNameContainer.querySelector("input[type='file']");
        if (fileInput && fileInput.files.length > 0) {
            checkModification();
        }
    });

    fileNameContainer.addEventListener("click", function (event) {
    	 if (event.target.closest("button")) {
    	        checkModification();
    	 }
    });

    // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ í˜ì´ì§€ ì´ë™
    cancelButton.addEventListener("click", function () {
        // URLì—ì„œ ê²Œì‹œíŒ IDì™€ ê²Œì‹œê¸€ IDë¥¼ ê°€ì ¸ì˜´
        const urlParams = new URLSearchParams(window.location.search);
        const bbsId = urlParams.get("bbsId");
        const nttId = urlParams.get("nttId");

        if (bbsId && nttId) {
            // ìƒì„¸í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = `/egowaeyo/article/articleDetail.do?bbsId=${encodeURIComponent(bbsId)}&nttId=${encodeURIComponent(nttId)}`;
        } else {
            console.error("bbsId ë˜ëŠ” nttIdê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    });
    
    // ë“±ë¡ ë²„íŠ¼ í´ë¦­ ì‹œ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
    submitButton.addEventListener("click", function () {
        if (!isModified) {
            alert("ìˆ˜ì •ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const bbsId = boardSelect.value;
        const nttId = new URLSearchParams(window.location.search).get("nttId");
        const nttSj = titleInput.value;
        const nttCn = contentTextarea.value;
        const fileInput = fileNameContainer.querySelector("input[type='file']");
        const file = fileInput ? fileInput.files[0] : null;

        if (!bbsId || !nttId || !nttSj || !nttCn) {
            alert("í•„ìˆ˜ ì…ë ¥ê°’ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
            return;
        }

        const formData = new FormData();
        formData.append("bbsId", bbsId);
        formData.append("nttId", nttId);
        formData.append("nttSj", nttSj);
        formData.append("nttCn", nttCn);

        if (file) {
            formData.append("files", file);
            formData.append("bbsFileName", file.name); // íŒŒì¼ ì´ë¦„ ì¶”ê°€
        }
    
        if (!file && fileNameContainer.innerText.trim() === "") {
            formData.append("bbsFileName", ""); 
        }

        fetch("articleUpdate.do", {
            method: "POST",
            body: formData,
        })
            .then(response => response.json())
            .then(data => {
                alert("ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                window.location.href = `articleDetail.do?bbsId=${bbsId}&nttId=${nttId}`;
            })
            .catch(error => {
                console.error("ê²Œì‹œê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                alert("ê²Œì‹œê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
        });


</script>
	</div>

</main>
</html>